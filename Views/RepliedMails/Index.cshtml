@model IEnumerable<EBookStore.Site.Models.ViewModels.RepliedMailVM>

@{
	ViewBag.Title = "Index";

	var criteria = ViewBag.Criteria as EBookStore.Site.Models.ViewModels.RepliedMailCriteria;

	var problemTypes = ViewBag.ProblemTypeId as SelectList;
	string s_problemTypeId = criteria.ProblemTypeId.HasValue ? criteria.ProblemTypeId.Value.ToString() : "";

}
@section cdn{
	<link href="~/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
}
@section Style
{
	<style>
		body {
			font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;
		}
        table {
            font-size: 16px;
            width: 500px;
            margin: 0 auto;
            background-color: #FFFFDF;
        }

		.fixed-cell {
			/*width: 200px;*/ /* 根據需要調整固定寬度 */
			white-space: nowrap;
		}

		h2 {
			color: #696969;
			font-family: DFYuanBold-B5;
		}

        thead {
            background-color: #fcfc4e;
        }
	</style>
}

<div class="container-fluid" style="width:90%">
	<h2 class="text-center">已回信件</h2>
	@*<p>
		@Html.ActionLink("Create New", "Create")
	</p>*@
	<form method="get">
		<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6">
			<div class="col">
				<select name="ProblemTypeId" id="s_problemTypeId" class="form-control">
					@foreach (var item in problemTypes)
					{
						<option value="@item.Value" @(s_problemTypeId == item.Value ? "selected" : "")>@item.Text</option>
					}
				</select>
			</div>
			<div class="col" id="datetimepicker1">
				<input type="date" class="form-control" name="CreatedTime" id="s_CreatedTime" value="@criteria.CreatedTime">
			</div>
			<div class="col d-flex justify-content-start">
				<button class="btn btn-primary">搜尋</button>
			</div>
		</div>
	</form>

	<div class="mt-3" style="overflow-y: scroll;">
		<table class="table table-bordered fixed-cell" id="dataTable" style="width:100%">
			<thead>
				<tr>
					<th>
						@Html.DisplayNameFor(model => model.Email)
					</th>
					<th>
						@Html.DisplayNameFor(model => model.UserAccount)
					</th>
					<th>
						@Html.DisplayNameFor(model => model.Title)
					</th>
					<th>
						@Html.DisplayNameFor(model => model.Content)
					</th>
					<th style="border-right:none">
						@Html.DisplayNameFor(model => model.CreatedTime)
					</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				@foreach (var item in Model)
				{
					<tr>
						<td>
                            @Html.DisplayFor(modelItem => item.Email)
						</td>
						<td>
							@Html.DisplayFor(modelItem => item.UserAccount)
						</td>
						<td>
							@Html.DisplayFor(modelItem => item.Title)
						</td>
						<td>
							<p class="ellipsis">
								@Html.DisplayFor(modelItem => item.Content)
							</p>
						</td>
						<td style="border-right:none">
							@Html.DisplayFor(modelItem => item.CreatedTime)
						</td>
						<td style="border-bottom: none;">
							<div class="d-grid gap-2">
								@Html.ActionLink("修改", "Edit", new { id = item.Id }, new { @class = "btn btn-sm btn-outline-primary" })
								@Html.ActionLink("詳細資料", "Details", new { id = item.Id }, new { @class = "btn btn-sm btn-outline-info" })
								<form id="deleteForm" action="/RepliedMails/Delete" method="POST" class="d-inline">
									<input type="hidden" name="deleteId" value="@item.Id">
									<button class="btn btn-sm btn-danger delete" type="submit">刪除
									</button>
								</form>
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
</div>

@section scripts{
	@Scripts.Render("~/bundles/jquery")

	<script src="~/Scripts/vendor/datatables/jquery.dataTables.min.js"></script>
	<script src="~/Scripts/vendor/datatables/dataTables.bootstrap4.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>

	<script>
		var basement = "https://localhost:44314";

		$(document).ready(function () {
			$("#dataTable").DataTable({
				"bPaginate": true, // 顯示換頁
				"searching": true, // 顯示搜尋
				"fixedHeader": false, // 標題置頂
				"lengthMenu": [8, 15, 30],  //顯示項目設定:10筆、20筆...
				"autoWidth": true,
				"ordering": false,
				language: {
					/*"order": [[5, 'desc']],*/
					"searchPlaceholder": "關鍵字搜尋",
					"emptyTable": "無資料...",
					"processing": "處理中...",
					"loadingRecords": "載入中...",
					"lengthMenu": "顯示 _MENU_ 筆",
					"zeroRecords": "無搜尋結果",
					"info": "_START_ 至 _END_ / 共 _TOTAL_ 筆",
					"infoEmpty": "尚無資料",
					"infoFiltered": "(從 _MAX_ 筆資料過濾)",
					"infoPostFix": "",
					"search": "",
					"oPaginate": {
						"sFirst": "首頁",
						"sPrevious": "上一頁",
						"sNext": "下一頁",
						"sLast": "末頁"
					}
				},
				"fnDrawCallback": function (oSettings) {
					// 內容超過n個字以"..."取代
					var length = 30;
					$(".ellipsis").each(function () {
						if ($(this).text().length > length) {
							$(this).attr("title", $(this).text());
							var text = $(this).text().substring(0, length - 1) + "...";
							$(this).text(text);
						}
					});
				}
			});

			$("#dataTable_length").each(function () {
				$(this).addClass("d-flex justify-content-start");
				$("div > label").css("width", "100%");
				$("div > label > select").css({ "display": "inline-block", "width": "60px" });
			});

			$("#dataTable_filter").each(function () {
				$(this).addClass("d-flex justify-content-end");
				$("div > label").css("width", "150px");
				$("div > label > input").css({ "display": "inline-block", "width": "100%" });
			});

		});

		$(function () {
			$('.delete').on('click', function (e) {
				e.preventDefault(); // 阻止默认的表单提交行为

				var form = $(this).closest('form'); // 获取最近的父级表单元素
				var deleteId = form.find('input[name="deleteId"]').val(); // 获取要删除的项的 ID

				Swal.fire({
					title: '確定要刪除嗎?',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#3085d6',
					cancelButtonColor: '#d33',
					confirmButtonText: '是的',
					cancelButtonText: '取消'
				}).then((result) => {
					if (result.isConfirmed) {
						// 使用 AJAX 或其他适当的方式将删除请求发送到服务器
						$.ajax({
							url: form.attr('action'),
							type: form.attr('method'),
							data: { id: deleteId },
							success: function (response) {
								// 处理服务器返回的成功响应
								Swal.fire(
									'刪除!',
									'已刪除這筆資料',
									'success'
								);
								location.reload(); // 刷新整个页面
							},
							error: function () {
								// 处理服务器返回的错误响应
								Swal.fire(
									'錯誤',
									'刪除失敗',
									'error'
								);
							}
						});
					}
				});
			});
		});
	</script>

}